#+title: Bilevel MCTS for Amortized O(1) Node Selection in Classical Planning
#+author: Masataro Asai
#+include: "head.org"

#+begin_outline-text-1
#+begin_center
*Masataro Asai*

MIT-IBM Watson AI Lab

IBM Research

Use arrow keys (←→) or n/p keys

#+end_center

#+begin_note
If you found the pdf version of this document, you can find the orignal web presentation in https://asai-research-presentation.github.io/2026-aaai26-O1MCTS/
#+end_note
#+end_outline-text-1

# PRS: Deterministic Planning,
# SO: Heuristic Search,
# ML: Online Learning & Bandits

* Overview

+ *Common Weakness of Monte-Carlo Tree Search*
+ Bilevel MCTS
+ Tree Collapsing
+ Nebula planner: SoTA results (MCTS+LAMA+BFWS)

* Monte Carlo Tree Search

[[png:bilevel/7]]

** Monte Carlo Tree Search

[[png:bilevel/6]]

** Monte Carlo Tree Search

[[png:bilevel/5]]

** Monte Carlo Tree Search

[[png:bilevel/5b]]

** Monte Carlo Tree Search

[[png:bilevel/4]]

** Monte Carlo Tree Search

[[png:bilevel/4b]]


* _/Weakness/_ : needs a */shallow search space/*


#+begin_container-fluid
#+begin_row-fluid
#+begin_span6

+
  #+begin_center
  Game of Go
  #+end_center

  [[png:Blank_Go_board]]

  Depth $d < 19^2=391$

#+end_span6
#+begin_span6

+
  #+begin_center
  Tower of Hanoi
  #+end_center

  [[png:Tower_of_Hanoi]]

  Depth $d = 2^k - 1$ ($k$ disks)

  .

  *Single Player Planning often requires
  an /exponential/ depth!*

#+end_span6
#+end_row-fluid
#+end_container-fluid


* _/Weakness/_ : Larger $d$ → Slower MCTS

[[png:bilevel/4b]]

** _/Weakness/_ : Larger $d$ → Slower MCTS

[[png:bilevel/3]]

** _/Weakness/_ : Larger $d$ → Slower MCTS

[[png:bilevel/2]]

* Proposed: _/Bilevel MCTS/_

[[png:bilevel/2]]

** Proposed: _/Bilevel MCTS/_

[[png:bilevel/1x]]

** Proposed: _/Bilevel MCTS/_

[[png:bilevel/1]]


* Theoretical Results

[[png:bilevel/1d]]

** Theoretical Results

[[png:bilevel/1c]]

** Theoretical Results

[[png:bilevel/1b]]

** Theoretical Results

[[png:bilevel/1b]]

+ MCTS */runtime per node/* ::
  $O(BD) = O(\log N)$. $N$: number of nodes

+ Bilevel MCTS _/amortized/_ */runtime per node/* over $D$ expansions ::

  $O(\log \log N)$ if _$Q$ = heap_

  $O(1)$ if _$Q$ = array-based priority queue_ (Dial 1969, Burns 2012)


* Evaluation on IPC 2018+2023

#+begin_smaller
#+begin_container-fluid
#+begin_row-fluid
#+begin_span6
+
  #+begin_center
  Instances solved in 5 min
  #+end_center

  |        | <c>  |   <c>   | <c>  |     <c>     |
  | /      |  <   |         |  >   |     <>      |
  |        | GBFS | Softmin | MCTS | */Bilevel/* |
  |--------+------+---------+------+-------------|
  | cea/18 |  40  |  48.4   | 50.2 |   *53.8*    |
  | cea/23 |  30  | *34.2*  | 25.8 |    30.8     |
  | cg/18  |  35  | *59.2*  | 42.4 |    56.2     |
  | cg/23  |  36  |  39.4   |  25  |   *41.6*    |
  | ff/18  |  60  |  80.2   | 79.8 |   *87.4*    |
  | ff/23  |  51  |  55.4   | 23.8 |   *58.2*    |
  |--------+------+---------+------+-------------|
  | total  | 252  |  316.8  | 247  |    *328*    |

#+end_span6

#+begin_span6
+
  #+begin_center
  IPC Agile scores
  #+end_center

  |        |  <c>  |   <c>   |  <c>   |     <c>     |
  | /      |   <   |         |   >    |     <>      |
  |        | GBFS  | Softmin |  MCTS  | */Bilevel/* |
  |--------+-------+---------+--------+-------------|
  | cea/18 | 17.7  |  20.6   | *23.8* |    22.4     |
  | cea/23 | 23.1  | *24.1*  |  21.5  |    23.8     |
  | cg/18  | 18.4  | *27.2*  |  19.9  |    26.1     |
  | cg/23  | 23.6  |  24.8   |  16.4  |   *25.5*    |
  | ff/18  | 30.4  |  37.7   |  40.4  |   *43.0*    |
  | ff/23  | 31.0  | *35.5*  |  19.0  |    32.9     |
  |--------+-------+---------+--------+-------------|
  | total  | 144.2 |  169.9  | 141.0  |   *173.8*   |

#+end_span6

#+end_row-fluid
#+end_container-fluid
#+end_smaller

Softmin: Softmin-type-h (Kuroiwa and Beck 2022)

* Expansion Speed [Nodes / sec]

#+begin_row-fluid
#+begin_container-fluid
#+begin_span6

#+begin_center
MCTS
#+end_center

+

  [[png:ucb1normal2-0.5-disabled-0--1-1.0-false-false-hff-false-False-false-10-disabled-False-fixed0.0-deterministic-legend]]

#+end_span6
#+begin_span6

#+begin_center
Bilevel MCTS

#+end_center

+

  [[png:ucb1normal2-0.5-depth-0--1-1.0-false-false-hff-false-False-false-10-disabled-False-fixed0.0-deterministic-legend]]

#+end_span6
#+end_container-fluid
#+end_row-fluid

* Bilevel MCTS uses a */Dynamic Depth Budget/*

[[png:budget/2]]

** Bilevel MCTS uses a */Dynamic Depth Budget/*

[[png:budget/1]]

* _/Fixed Budget $b=10^k$/_ vs. */Depth Budget $b=d$/*

#+begin_center
Instances solved in 5 min
#+end_center

|        |   <c>   |  <c>   |    <c>    |   <c>    |   <c>    |   <c>   |
| /      |    <    |        |           |          |    >     |   <>    |
|        | _/b=1/_ | _/10/_ | _/10^2/_  | _/10^3/_ | _/10^4/_ | */b=d/* |
|--------+---------+--------+-----------+----------+----------+---------|
| cea/18 |  50.2   | *57.6* |   51.8    |    49    |   46.6   |  53.8   |
| cea/23 |  25.8   |  32.4  |  *36.8*   |   33.8   |   33.6   |  30.8   |
| cg/18  |  42.4   |  51.6  |   55.8    |   48.6   |   48.8   | *56.2*  |
| cg/23  |   25    |  34.2  |   42.2    |   *44*   |   42.2   |  41.6   |
| ff/18  |  79.8   |  85.8  |   83.4    |   82.2   |   72.8   | *87.4*  |
| ff/23  |  23.8   |  45.4  |   56.8    |   *60*   |   58.6   |  58.2   |
|--------+---------+--------+-----------+----------+----------+---------|
| total  |   247   | ↗307  | ↗326.8↘ | 317.6↘  |  302.6   |  *328*  |

#+begin_container-fluid
#+begin_row-fluid
#+begin_span6
+ Fixed budget :: _/Too many / few BFS/_
#+end_span6
#+begin_span6
+ Dynamic budget :: */Handles various scenarios well/*
#+end_span6
#+end_row-fluid
#+end_container-fluid



# #+begin_smaller
# #+begin_container-fluid
# #+begin_row-fluid
# #+begin_span6
# +
#   #+begin_center
#   Instances solved in 5 min
#   #+end_center
#
#   |        | <c>  |  <c>   |        |        |        |        |
#   | /      |  <>  |   <>   |        |        |        |      > |
#   |        | b=1  |  b=d   |   b=10 |   10^2 |   10^3 |   10^4 |
#   |--------+------+--------+--------+--------+--------+--------|
#   | cea/18 | 50.2 | *53.8* | *57.6* |   51.8 |     49 |   46.6 |
#   | cea/23 | 25.8 |  30.8  |   32.4 | *36.8* | *33.8* |   33.6 |
#   | cg/18  | 42.4 | *56.2* |   51.6 | *55.8* |   48.6 |   48.8 |
#   | cg/23  |  25  |  41.6  |   34.2 | *42.2* |     44 | *42.2* |
#   | ff/18  | 79.8 | *87.4* | *85.8* |   83.4 |   82.2 |   72.8 |
#   | ff/23  | 23.8 |  58.2  |   45.4 |   56.8 |   *60* | *58.6* |
#   |--------+------+--------+--------+--------+--------+--------|
#   | total  | 247  | *328*  |    307 |  326.8 |  317.6 |  302.6 |
#
# #+end_span6
#
# #+begin_span6
# +
#   #+begin_center
#   IPC Agile scores
#   #+end_center
#
#   |  <c>   |   <c>   |        |        |       |        |
#   |   /    |   <>    |        |        |       |     >  |
#   |  b=1   |   b=d   |   b=10 |   10^2 |  10^3 |   10^4 |
#   |--------+---------+--------+--------+-------+--------|
#   | *23.8* |  22.4   | *23.1* |   22.1 |  20.8 |   18.8 |
#   |  21.5  |  23.8   | *25.0* | *26.3* |  24.8 |   23.7 |
#   |  19.9  | *26.1*  |   23.9 | *25.1* |  23.3 |   21.8 |
#   |  16.4  | *25.5*  |   22.0 |   24.4 |  24.0 | *24.6* |
#   |  40.4  |  43.0   | *44.3* | *43.8* |  39.5 |   35.6 |
#   |  19.0  |  32.9   |   27.3 | *34.0* |  32.7 | *33.4* |
#   |--------+---------+--------+--------+-------+--------|
#   | 141.0  | *173.8* |  165.6 |  175.7 | 165.2 |  158.1 |
#
# #+end_span6
#
# #+end_row-fluid
# #+end_container-fluid
# #+end_smaller

* If a large $d$ slows down MCTS, _/what if we reduce $d$?/_ : → _/Tree Collapsing/_



[[png:bilevel/2]]

** If a large $d$ slows down MCTS, _/what if we reduce $d$?/_ : → _/Tree Collapsing/_

Hyperparameter: $\theta$

*When $n$ has too few children ...*

[[png:collapsing1]]

→

** If a large $d$ slows down MCTS, _/what if we reduce $d$?/_ : → _/Tree Collapsing/_

Hyperparameter: $\theta$

*When $n$ has too few children ... /adopt them to the grandparent $n'$/*

[[png:collapsing]]

→

** If a large $d$ slows down MCTS, _/what if we reduce $d$?/_ : → _/Tree Collapsing/_

Hyperparameter: $\theta$

*When $n$ has too few children ... /adopt them to the grandparent $n'$/*

[[png:collapsing]]

→ _/We also made $\theta$ dynamic ($\theta=d$)/_

** If a large $d$ slows down MCTS, _/what if we reduce $d$?/_ : → _/Tree Collapsing/_

#+begin_center
Number of instances solved (5 min)
#+end_center

| /      |     < |             |         |            |         |       > |             |
|        | no TC | $\theta=10$ |      20 |         40 |      80 |     160 | */Dynamic/* |
|--------+-------+-------------+---------+------------+---------+---------+-------------|
| cea/18 |  53.8 |        56.4 |  *61.4* |       58.6 |    58.8 |    57.8 |          61 |
| cea/23 |  30.8 |          32 |    32.2 |       34.2 |      33 |  *34.4* |        33.4 |
| cg/18  |  56.2 |        58.4 |    59.6 |     *60.2* |    59.8 |    56.2 |        57.6 |
| cg/23  |  41.6 |        41.6 |      42 |       45.8 |    45.4 |    43.4 |      *46.4* |
| ff/18  |  87.4 |        87.2 |    88.6 |       90.4 |    90.6 |  *91.4* |        90.2 |
| ff/23  |  58.2 |        56.8 |    57.8 |         58 |    56.2 |      55 |      *58.4* |
|--------+-------+-------------+---------+------------+---------+---------+-------------|
| total  |   328 |     ↗332.4 | ↗341.6 | ↗ *347.2* | ↘343.8 | ↘338.2 |       *347* |

*/Dynamic:/* Not always the best ($\theta=40$) but is *robust*

* *N /ε/ bula* = Bilevel MCTS + BFWS + LAMA

*N /ε/ bula* : */3/ best practices* in a single planner
+ */Search algorithm/* : Bilevel MCTS + dynamic tree collapsing
+ */Heuristics/* : LAMA (2010)'s boosted alt queue + $h^{\mathrm{FF}}$ + $h^{\mathrm{LMcount}}$
+ */State-based Exploration/* : Prioritize states with Novelty Metric (2017)
+ *Codebase* : Fast Downward
+ *Eager search* : Laziness hurts this MCTS so far

** Results

|                             |  <c>  |   <c>   |  <c>  |  <c>  |       <c>       |
| IPC18+IPC23 with            | LAMA  | SM-Type |  Dec  |  NO   | N$\epsilon$bula |
| 5 min and 30 min limits     |       |  -LAMA  | Star  |  LAN  |                 |
|-----------------------------+-------+---------+-------+-------+-----------------|
| solved instances $(T=300)$  |  177  |  186.4  |  162  |  177  |     *192.2*     |
| IPC Agile score  $(T=300)$  | 95.4  |  99.3   | 93.7  | 92.8  |     *99.4*      |
|-----------------------------+-------+---------+-------+-------+-----------------|
| solved instances $(T=1800)$ |  204  |  213.4  |  180  |  219  |     *230.6*     |
| IPC Agile score  $(T=1800)$ | 117.6 |  123.4  | 112.0 | 118.7 |     *126.8*     |

# |                             |  LAMA | SM-Type |   Dec |    NO |  LAMA |       |       |       | N$\epsilon$bula |
# |                             |       |   -LAMA |  Star |   LAN | eager |       |       |       |                 |
# |-----------------------------+-------+---------+-------+-------+-------+-------+-------+-------+-----------------|
# | solved instances ($T=300$)  |   177 |   186.4 |   162 |   177 |   159 |   172 | 167.4 | 156.2 |           192.2 |
# | IPC Agile score  ($T=300$)  |  95.4 |    99.3 |  93.7 |  92.8 |  85.4 |  85.2 |  86.8 |  79.1 |            99.4 |
# |-----------------------------+-------+---------+-------+-------+-------+-------+-------+-------+-----------------|
# | solved instances ($T=1800$) |   204 |   213.4 |   180 |   219 |   186 |   226 | 207.2 |   185 |           230.6 |
# | IPC Agile score  ($T=1800$) | 117.6 |   123.4 | 112.0 | 118.7 | 107.1 | 112.8 | 111.8 | 101.0 |           126.8 |

\[
\text{IPC Agile score} = \sum_i \min \{1, \log t_i / \log T\}
\]

** Runtime Histogram

[[png:ucb1normal2nlapsb3-0.5-depth--1--1-1.0-false-false-hff-false-False-false-10-disabled-False-fixed0.0-deterministic]]

* Conclusion

Recursive selection is a bottleneck in MCTS (causes $O(\log N)$)
+ → Large depth $d$ hurts
+ → Bilevel MCTS: Amortize the bottleneck with a *budgeted BFS*

  　→ $O(\log \log N)$ or $O(1)$
+ → Tree Collapsing: Reduce the depth $d$
+ *N /ε/ bula* : SotA by combining MCTS+LAMA+BFWS

